<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
	xmlns:layout="http://www.ultraq.net.nz"
	xmlns:sec="http://www.thymeleaf.org"
	layout:decorate="~{layout/default}">
<body>
    <main layout:fragment="content">
		<div class="mb-3">
			<button sec:authorize="hasRole('ADMIN')" class="btn" data-bs-toggle="collapse" data-bs-target="#addInviteForm">
				+ Add New Invite
			</button>
		</div>

		<div sec:authorize="hasRole('ADMIN')" id="addInviteForm" class="collapse mb-4">
			<div class="card card-body shadow-sm">
				<form th:action="@{/admin/invite/save}" th:object="${newInvite}" method="post" class="row g-3">
					<div class="col-md-3">
						<input type="text" th:field="*{firstName}" class="form-control" placeholder="First Name" required>
					</div>
					<div class="col-md-3">
						<input type="text" th:field="*{lastName}" class="form-control" placeholder="Last Name" required>
					</div>
					<div class="col-md-3">
						<input type="text" th:field="*{email}" 
							class="form-control" 
							th:classappend="${#fields.hasErrors('email')} ? 'is-invalid' : ''" 
							placeholder="Email" required>
						<div class="invalid-feedback" th:if="${#fields.hasErrors('email')}" th:errors="*{email}">
							Email Error Message
						</div>
					</div>
					<div class="col-md-2">
						<button type="submit" class="btn btn-success w-100">Save</button>
					</div>
					<script th:if="${#fields.hasAnyErrors()}">
						$(document).ready(function() {
							$('#addInviteForm').addClass('show');
						});
					</script>
				</form>
			</div>
		</div>

		<table id="configTable" class="datatables table table-striped table-hover stripe" style="display:none;">
			<thead>
				<tr>
					<th sec:authorize="hasRole('ADMIN')"></th>
					<th>First Name</th>
					<th>Last Name</th>
					<th>Email</th>
				</tr>
			</thead>
			<tbody>
				<tr th:each="invite : ${invites}">
					<td sec:authorize="hasRole('ADMIN')">
						<form th:action="@{/admin/invite/delete/{id}(id=${invite.inviteId})}" method="post" class="d-inline">
							<button type="button"
									style="background: none; border: none; padding: 0; cursor: pointer; color: #dc3545;"
									onclick="submitForm(this, 'Are you sure? This will permanently delete this invite.')">
								<i class="fa-solid fa-x"></i>
							</button>
						</form>
					</td>
					<td th:text="${invite.firstName}"></td>
					<td th:text="${invite.lastName}"></td>
					<td th:text="${invite.email}"></td>
					<td>
						<span th:if="${invite.userId != null}" class="badge bg-success">
							Invite Accepted
						</span>

						<!-- Case 2: Invite is still pending (userId is null) -->
						<button th:unless="${invite.userId != null}"
								class="btn btn-outline-primary btn-sm" 
								th:data-name="${invite.firstName + ' ' + invite.lastName}"
								th:data-key="${invite.key}"
								onclick="copyInvite(this)">
							<i class="fa-solid fa-copy"></i> Copy Email Body
						</button>
					</td>
				</tr>
			</tbody>
		</table>

		<script>
			$(document).ready(function () {
				$('#configTable').DataTable({
					"pageLength": 25,
					"lengthMenu": [ [10, 25, 50, -1], [10, 25, 50, "All"] ],
					"paging": true,
					"lengthChange": true,
					"searching": true,
					"ordering": true,
					"info": true,
					"autoWidth": false,
					"responsive": true,
					"order": [{ "idx": 2, "dir": 'asc' }, { "idx": 1, "dir": 'asc' }],  
					"columnDefs": [
						{ width: '2%', targets: [0] }, 
						{ width: '20%', targets: [1,2,3] }, 
						{ width: '15%', targets: [4], orderable: false }
					],
					initComplete: function() {
						$(this).show(); // Show table after DataTables is ready
					}
				});
			});
		</script>
    </main>
</body>
</html>
