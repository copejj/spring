<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
	xmlns:layout="http://www.ultraq.net.nz"
	layout:decorate="~{layout/default}">
	<body>
		<h2>/logs/list.html</h2>
        <div layout:fragment="content" class="mt-4"> 
            <div th:replace="~{fragments/forms :: direct-button(url='/logs/create', text='Add New Application')}"></div>

            <div class='filter-box' th:if="${selectedWeek != null or selectedCompany != null}">
                <span class="title">Active Filters:</span>
                <span class="clear-button" th:if="${selectedCompany != null}">
                    <a th:href="@{/logs/list(weekId=${selectedWeek})}" style="text-decoration: none;"> 
                        <span>Company</span>
                        <i class="fa-solid fa-x"></i> 
                    </a>
                </span>
                <span class="clear-button" th:if="${selectedWeek != null}">
                    <a th:href="@{/logs/list(companyId=${selectedCompany})}" style="text-decoration: none;">
                        <span>Week</span>
                        <i class="fa-solid fa-x"></i>
                    </a>
                </span>
                <span class="clear-button" >
                    <a th:href="@{/logs/list}" style="text-decoration: none;"> 
                        <span>Clear ALL</span>
                        <i class="fa-solid fa-x"></i> 
                    </a>
                </span>
            </div>
            <div class="container mt-3" th:if="${saveSuccess != null or saveError != null}">
                <div th:if="${saveSuccess}" class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <span th:text="${saveSuccess}">Success!</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                <div th:if="${saveError}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <span th:text="${saveError}">Error!</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </div>
            <table id="logsTable" class="datatables table table-striped table-hover stripe" style="display:none;">
                <thead>
                    <tr>
                        <th></th>
                        <th>Week</th>
                        <th>Action Date</th>
                        <th>Company Name</th>
                        <th>Title</th>
                        <th>Current Status</th>
                        <th>Job Number</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="log : ${logs}">
                        <td style="text-align: center;">
                            <a th:href="@{/logs/edit/{id}(id=${log.logId})}">
                                <i class="fa-solid fa-pen-to-square"></i>
                            </a>
                        </td>
                        <td>
                            <a th:href="@{/logs/list(
                                    companyId=${selectedCompany}, 
                                    weekId=${selectedWeek == log.weekId ? '' : log.weekId}
                                )}" 
                                th:classappend="${selectedWeek == log.weekId? 'active-filter' : ''}"
                                style="text-decoration: none;"
                                title="Click to filter or click again to clear">
                                <i class="fa-solid fa-filter"></i>
                            </a>
                            <span th:text="${log.startDate} + ' - ' + ${log.endDate}"></span>
                        </td>
                        <td th:text="${log.actionDate}"></td>
                        <td>
                            <a th:href="@{/companies/edit/{id}(id=${log.companyId})}"
                                style="text-decoration: none;"
                                title="Edit this company">
                                <i class="fa-solid fa-pen-to-square"></i>
                            </a>
                            <a th:href="@{/logs/list(
                                    companyId=${selectedCompany == log.companyId ? '' : log.companyId}, 
                                    weekId=${selectedWeek}
                                )}" 
                                th:classappend="${selectedCompany == log.companyId ? 'active-filter' : ''}"
                                style="text-decoration: none;"
                                title="Click to filter or click again to clear">
                                <i class="fa-solid fa-filter"></i>
                            </a>
                            <span th:text="${log.companyName}"></span>
                        </td>
                        <td th:text="${log.title}"></td>
                        <td th:text="${log.logStatuses != null && !log.logStatuses.isEmpty() ? log.logStatuses[0].status : ''}"></td>
                        <td th:text="${log.jobNumber}"></td>
                    </tr>
                </tbody>
            </table>
            <script>
                $(document).ready(function () {
                    $('#logsTable').DataTable({
                        "pageLength": 25,
                        "lengthMenu": [ [10, 25, 50, -1], [10, 25, 50, "All"] ],
                        "paging": true,
                        "lengthChange": true,
                        "searching": true,
                        "ordering": true,
                        "info": true,
                        "autoWidth": false,
                        "order": [{ "idx": 2, "dir": 'desc' }, { "idx": 3, "dir": 'asc' }], 
                        "columnDefs": [
                            { width: '3%', targets: [0] }, 
                            { width: '13%', targets: [1] }, 
                            { width: '8%', targets: [2] }, 
                            { width: '20%', targets: [3] }, 
                            { orderable: false, targets: [0] }
                        ],
                        "responsive": true,
                        initComplete: function() {
                            $(this).addClass('d-some');
                        }
                    });
                });
            </script>
        </div>
		</div>
	</body>
</html>
