<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
	xmlns:layout="http://www.ultraq.net.nz"
	layout:decorate="~{layout/default}">
	<body>
        <div layout:fragment="content" class="container mt-4"> 
            <!-- Alerts -->
            <div th:if="${saveError}" class="alert alert-danger" th:text="${saveError}"></div>
            <div th:if="${saveSuccess}" class="alert alert-success" th:text="${saveSuccess}"></div>

            <form th:action="@{/companies/update}" th:object="${company}" th:method="post">
                <input th:field="*{companyId}" type="hidden" />

                <!-- Row 1: Primary Info (3 Columns) -->
                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <label th:for="companyName" class="form-label">Company Name</label>
                        <input th:field="*{companyName}" type="text" 
                            class="form-control" th:classappend="${#fields.hasErrors('companyName')} ? 'is-invalid' : ''" />
                        <div th:if="${#fields.hasErrors('companyName')}" th:errors="*{companyName}" class="invalid-feedback"></div>
                    </div>

                    <div class="col-md-4">
                        <label th:for="companyEmail" class="form-label">Company Email</label>
                        <input th:field="*{companyEmail}" type="email" class="form-control" />
                    </div>

                    <div class="col-md-4">
                        <label th:for="companyWebsite" class="form-label">Company Website</label>
                        <div class="input-group">
                            <input th:field="*{companyWebsite}" type="text" class="form-control" placeholder="https://..." />
                            <a th:href="*{companyWebsite}" target="_blank" rel="noopener noreferrer" class="btn btn-outline-secondary" title="Visit Site">
                                <i class="fa-solid fa-arrow-up-right-from-square"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Row 2: Communication (1/3 width each) -->
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <label th:for="companyPhone" class="form-label">Company Phone</label>
                        <input th:field="*{companyPhone}" type="text" class="form-control" />
                    </div>
                    <div class="col-md-4">
                        <label th:for="companyFax" class="form-label">Company Fax</label>
                        <input th:field="*{companyFax}" type="text" class="form-control" />
                    </div>
                </div>

                <!-- ADDRESSES SECTION -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Addresses</h5>
                        <button type="button" class="btn btn-sm btn-success" onclick="addAddress()">+ Add Address</button>
                    </div>
                    <div class="card-body" id="address-container">
                        <div th:each="addr, iter : *{addresses}" class="address-row border-bottom pb-4 mb-4">
                            <input type="hidden" th:field="*{addresses[__${iter.index}__].addressId}" />
                            
                            <!-- Error handling for row -->
                            <div th:if="${#fields.hasErrors('addresses[' + iter.index + '].street')}" class="alert alert-sm alert-danger py-1 mb-2">
                                <small th:errors="*{addresses[__${iter.index}__].street}"></small>
                            </div>

                            <!-- Address Row 1 -->
                            <div class="row g-3 mb-2">
                                <div class="col-md-3">
                                    <label class="form-label">Type</label>
                                    <select th:field="*{addresses[__${iter.index}__].type}" class="form-select">
                                        <option value="">[ Type ]</option>
                                        <option th:each="t : ${allAddressTypes}" th:value="${t.name}" th:text="${t.name}"></option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Street</label>
                                    <input th:field="*{addresses[__${iter.index}__].street}" oninput="parse_address(this)" type="text" class="form-control" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Suite/Apt</label>
                                    <input th:field="*{addresses[__${iter.index}__].streetExt}" type="text" class="form-control" />
                                </div>
                            </div>

                            <!-- Address Row 2 -->
                            <div class="row g-3 mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">City</label>
                                    <input th:field="*{addresses[__${iter.index}__].city}" type="text" class="form-control" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">State</label>
                                    <select th:field="*{addresses[__${iter.index}__].stateAbbr}" class="form-select">
                                        <option value="">[ State ]</option>
                                        <option th:each="st : ${allStates}" th:value="${st.abbr}" th:text="${st.name}"></option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Zip</label>
                                    <input th:field="*{addresses[__${iter.index}__].zip}" type="text" class="form-control" />
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button type="button" class="btn btn-outline-danger w-100" onclick="removeAndReindex(this)">Remove</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="mt-4 pb-5">
                    <button type="submit" class="btn btn-primary px-5">Save Company</button>
                    <a href="/companies" class="btn btn-secondary px-4 ms-2">Cancel</a>
                </div>
            </form>		
        </div>
	</body>
</html>
