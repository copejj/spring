on:
    release:
        types: [published]

jobs:
    deploy-to-production:
        runs-on: ubuntu-latest
        steps:
            -   name: Execute Remote Deployment
                uses: appleboy/ssh-action@v1.2.0
                with:
                    host: ${{ vars.PROD_HOST }}
                    username: ${{ secrets.SSH_PRIVATE_USERNAME }}
                    key: ${{ secrets.SSH_PRIVATE_KEY }}
                    # IMPORTANT: All variables used in the script must be listed here
                    envs: DB_NAME,DB_USER,DB_PASS,DB_HOST,DB_URL,API_BASE_URL,SERVER_CONTEXT_PATH,TAG_NAME
                    script: |
                        # 1. Sync Code
                        cd ${{ vars.PROD_APP_PATH }}
                        git fetch --tags --all
                        git checkout $TAG_NAME

                        # 2. Database Migrations
                        export PGPASSWORD="$DB_PASS"
                        DB_ARGS="-h $DB_HOST -U $DB_USER -d $DB_NAME -t"

                        psql $DB_ARGS -f sql/init_schema.sql

                        FILES=$(find sql/migrations -regextype posix-extended -regex ".*/[0-9]{8}_[0-9]+.*\.sql" | sort)
                        for FILE in $FILES; do
                            FILENAME=$(basename "$FILE")
                            ALREADY_RUN=$(psql $DB_ARGS -A -c "SELECT 1 FROM schema_migrations WHERE filename='$FILENAME' AND status='completed';")
                            if [ "$ALREADY_RUN" == "1" ]; then continue; fi

                            psql $DB_ARGS -c "INSERT INTO schema_migrations (filename, status) VALUES ('$FILENAME', 'pending') ON CONFLICT (filename) DO UPDATE SET status='pending', started_at=NOW(), ended_at=NULL;"
                            if psql $DB_ARGS -f "$FILE"; then
                                psql $DB_ARGS -c "UPDATE schema_migrations SET ended_at=NOW() WHERE filename='$FILENAME';"
                            else
                                psql $DB_ARGS -c "UPDATE schema_migrations SET error_message='Failed during deployment' WHERE filename='$FILENAME';"
                                exit 1
                            fi
                        done

                        # 3. Handle Configuration (Re-enabled)
                        # We use | as a delimiter in case your URLs or passwords have / characters
                        sed -i "s|<db_url>|$DB_URL|g" src/main/resources/application.properties
                        sed -i "s|<db_user>|$DB_USER|g" src/main/resources/application.properties
                        sed -i "s|<db_pass>|$DB_PASS|g" src/main/resources/application.properties
                        sed -i "s|<api_base_url>|$API_BASE_URL|g" src/main/resources/application.properties
                        sed -i "s|<server_context_path>|$SERVER_CONTEXT_PATH|g" src/main/resources/application.properties

                        # 4. Build WAR File
                        mvn clean package -DskipTests

                        # 5. Deploy to Tomcat
                        # Path to the specific WAR generated by Maven
                        BUILD_WAR="${{ vars.PROD_APP_PATH}}/target/${{ vars.PROD_APP_NAME }}.war"

                        # Archive and Deploy
                        cp "$BUILD_WAR" "${{ vars.PROD_DEPLOY_PATH }}/${{ vars.PROD_APP_NAME }}-$TAG_NAME.war"
                        cp "$BUILD_WAR" "${{ vars.PROD_DEPLOY_PATH }}/${{ vars.PROD_DEPLOY_NAME }}.war"

                        # 6. Clean up secrets from source properties file
                        git checkout .

                        # 7. Clean up maven directory
                        mvn clean

                        echo "Deployment of $TAG_NAME completed successfully."
                env:
                    DB_NAME: ${{ secrets.DB_NAME }}
                    DB_USER: ${{ secrets.DB_USER }}
                    DB_PASS: ${{ secrets.DB_PASS }}
                    DB_HOST: ${{ secrets.DB_HOST }}
                    DB_URL: ${{ secrets.DB_URL }}
                    API_BASE_URL: ${{ vars.API_BASE_URL }}
                    SERVER_CONTEXT_PATH: ${{ vars.SERVER_CONTEXT_PATH }}
                    TAG_NAME: ${{ github.event.release.tag_name }}